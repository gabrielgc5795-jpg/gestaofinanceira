<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gestão Financeira Avançado</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .dashboard-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            padding: 20px;
        }
        
        .dashboard-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 4px solid #3b82f6;
        }
        
        .dashboard-card h3 {
            margin: 0 0 15px 0;
            color: #1f2937;
            font-size: 1.2em;
        }
        
        .metric-value {
            font-size: 2em;
            font-weight: bold;
            color: #3b82f6;
            margin: 10px 0;
        }
        
        .metric-change {
            font-size: 0.9em;
            padding: 4px 8px;
            border-radius: 4px;
            display: inline-block;
        }
        
        .metric-change.positive {
            background: #d1fae5;
            color: #065f46;
        }
        
        .metric-change.negative {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            margin: 20px 0;
        }
        
        .alert-item {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 6px;
            padding: 12px;
            margin: 8px 0;
        }
        
        .alert-item.critical {
            background: #fee2e2;
            border-color: #ef4444;
        }
        
        .alert-item.warning {
            background: #fef3c7;
            border-color: #f59e0b;
        }
        
        .alert-item.info {
            background: #dbeafe;
            border-color: #3b82f6;
        }
        
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .kpi-item {
            text-align: center;
            padding: 15px;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        
        .kpi-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #1f2937;
        }
        
        .kpi-label {
            font-size: 0.9em;
            color: #6b7280;
            margin-top: 5px;
        }
        
        .trend-indicator {
            display: inline-block;
            margin-left: 8px;
        }
        
        .trend-up {
            color: #10b981;
        }
        
        .trend-down {
            color: #ef4444;
        }
        
        .trend-stable {
            color: #6b7280;
        }
        
        .report-section {
            margin: 30px 0;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .report-section h2 {
            color: #1f2937;
            border-bottom: 2px solid #3b82f6;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        
        .table-container {
            overflow-x: auto;
            margin: 20px 0;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        
        th {
            background: #f9fafb;
            font-weight: 600;
            color: #374151;
        }
        
        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: 500;
        }
        
        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }
        
        .status-paid {
            background: #d1fae5;
            color: #065f46;
        }
        
        .status-overdue {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .risk-low {
            color: #10b981;
        }
        
        .risk-medium {
            color: #f59e0b;
        }
        
        .risk-high {
            color: #ef4444;
        }
        
        .risk-critical {
            color: #991b1b;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1><i class="fas fa-chart-line"></i> Sistema de Gestão Financeira Avançado</h1>
            <p>Dashboard completo com contas a pagar/receber, projeções financeiras, orçamento, investimentos, relatórios e auditoria</p>
        </header>

        <div class="dashboard-container">
            <!-- Resumo Financeiro -->
            <div class="dashboard-card">
                <h3><i class="fas fa-wallet"></i> Resumo Financeiro</h3>
                <div id="financial-summary">
                    <div class="metric-value" id="total-revenue">R$ 0,00</div>
                    <div class="metric-change positive" id="revenue-change">+0%</div>
                    <p>Receita Total</p>
                    
                    <div class="metric-value" id="total-expenses">R$ 0,00</div>
                    <div class="metric-change negative" id="expense-change">+0%</div>
                    <p>Despesas Totais</p>
                    
                    <div class="metric-value" id="net-profit">R$ 0,00</div>
                    <div class="metric-change" id="profit-change">+0%</div>
                    <p>Lucro Líquido</p>
                </div>
            </div>

            <!-- Contas a Pagar -->
            <div class="dashboard-card">
                <h3><i class="fas fa-credit-card"></i> Contas a Pagar</h3>
                <div id="payable-summary">
                    <div class="metric-value" id="payable-amount">R$ 0,00</div>
                    <p>Total Pendente</p>
                    
                    <div class="metric-value" id="overdue-count">0</div>
                    <p>Contas Vencidas</p>
                    
                    <div class="metric-value" id="upcoming-count">0</div>
                    <p>Próximas a Vencer</p>
                </div>
            </div>

            <!-- Contas a Receber -->
            <div class="dashboard-card">
                <h3><i class="fas fa-hand-holding-usd"></i> Contas a Receber</h3>
                <div id="receivable-summary">
                    <div class="metric-value" id="receivable-amount">R$ 0,00</div>
                    <p>Total Pendente</p>
                    
                    <div class="metric-value" id="overdue-receivable-count">0</div>
                    <p>Contas Vencidas</p>
                    
                    <div class="metric-value" id="upcoming-receivable-count">0</div>
                    <p>Próximas a Vencer</p>
                </div>
            </div>

            <!-- Fluxo de Caixa -->
            <div class="dashboard-card">
                <h3><i class="fas fa-chart-area"></i> Fluxo de Caixa</h3>
                <div class="chart-container">
                    <canvas id="cash-flow-chart"></canvas>
                </div>
            </div>

            <!-- KPIs Principais -->
            <div class="dashboard-card">
                <h3><i class="fas fa-tachometer-alt"></i> KPIs Principais</h3>
                <div class="kpi-grid" id="kpi-grid">
                    <!-- KPIs serão carregados dinamicamente -->
                </div>
            </div>

            <!-- Alertas e Notificações -->
            <div class="dashboard-card">
                <h3><i class="fas fa-exclamation-triangle"></i> Alertas</h3>
                <div id="alerts-container">
                    <!-- Alertas serão carregados dinamicamente -->
                </div>
            </div>
        </div>

        <!-- Análise de Inadimplência -->
        <div class="report-section">
            <h2><i class="fas fa-chart-pie"></i> Análise de Inadimplência</h2>
            <div id="delinquency-analysis">
                <!-- Análise será carregada dinamicamente -->
            </div>
        </div>

        <!-- Projeções Financeiras -->
        <div class="report-section">
            <h2><i class="fas fa-crystal-ball"></i> Projeções Financeiras</h2>
            <div class="chart-container">
                <canvas id="projections-chart"></canvas>
            </div>
            <div id="projections-summary">
                <!-- Resumo das projeções será carregado dinamicamente -->
            </div>
        </div>

        <!-- Status do Orçamento -->
        <div class="report-section">
            <h2><i class="fas fa-piggy-bank"></i> Status do Orçamento</h2>
            <div id="budget-status">
                <!-- Status do orçamento será carregado dinamicamente -->
            </div>
        </div>

        <!-- Gestão de Investimentos -->
        <div class="report-section">
            <h2><i class="fas fa-chart-line"></i> Gestão de Investimentos</h2>
            <div id="investment-summary">
                <!-- Resumo dos investimentos será carregado dinamicamente -->
            </div>
        </div>

        <!-- Relatórios Financeiros -->
        <div class="report-section">
            <h2><i class="fas fa-file-invoice"></i> Relatórios Financeiros</h2>
            <div class="table-container">
                <table id="reports-table">
                    <thead>
                        <tr>
                            <th>Relatório</th>
                            <th>Período</th>
                            <th>Status</th>
                            <th>Gerado em</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="reports-tbody">
                        <!-- Relatórios serão carregados dinamicamente -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Log de Auditoria -->
        <div class="report-section">
            <h2><i class="fas fa-history"></i> Log de Auditoria</h2>
            <div class="table-container">
                <table id="audit-table">
                    <thead>
                        <tr>
                            <th>Data/Hora</th>
                            <th>Usuário</th>
                            <th>Ação</th>
                            <th>Entidade</th>
                            <th>Severidade</th>
                        </tr>
                    </thead>
                    <tbody id="audit-tbody">
                        <!-- Logs de auditoria serão carregados dinamicamente -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="common.js"></script>
    <script src="secure-storage.js"></script>
    <script src="accounts-payable-receivable.js"></script>
    <script src="financial-projections.js"></script>
    <script src="budget-control.js"></script>
    <script src="investment-management.js"></script>
    <script src="financial-reports.js"></script>
    <script src="kpi-dashboard.js"></script>
    <script src="audit-system.js"></script>
    
    <script>
        // Inicialização do dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeDashboard();
        });

        async function initializeDashboard() {
            try {
                // Carrega dados iniciais
                await loadFinancialSummary();
                await loadAccountsSummary();
                await loadKPIs();
                await loadAlerts();
                await loadDelinquencyAnalysis();
                await loadProjections();
                await loadBudgetStatus();
                await loadInvestmentSummary();
                await loadReports();
                await loadAuditLogs();
                
                // Configura atualizações automáticas
                setInterval(updateDashboard, 300000); // 5 minutos
                
                console.log('Dashboard inicializado com sucesso');
            } catch (error) {
                console.error('Erro ao inicializar dashboard:', error);
            }
        }

        async function loadFinancialSummary() {
            try {
                if (typeof financialControl !== 'undefined') {
                    const summary = financialControl.getFinancialSummary();
                    
                    document.getElementById('total-revenue').textContent = 
                        formatCurrency(summary.totalRevenue || 0);
                    document.getElementById('total-expenses').textContent = 
                        formatCurrency(summary.totalExpenses || 0);
                    document.getElementById('net-profit').textContent = 
                        formatCurrency(summary.netProfit || 0);
                }
            } catch (error) {
                console.error('Erro ao carregar resumo financeiro:', error);
            }
        }

        async function loadAccountsSummary() {
            try {
                if (typeof accountsPayableReceivable !== 'undefined') {
                    const summary = accountsPayableReceivable.getFinancialSummary();
                    const overdue = accountsPayableReceivable.getOverdueAccounts();
                    const upcoming = accountsPayableReceivable.getUpcomingAccounts();
                    
                    // Contas a pagar
                    document.getElementById('payable-amount').textContent = 
                        formatCurrency(summary.pendingPayable.amount);
                    document.getElementById('overdue-count').textContent = 
                        overdue.payable.length;
                    document.getElementById('upcoming-count').textContent = 
                        upcoming.payable.length;
                    
                    // Contas a receber
                    document.getElementById('receivable-amount').textContent = 
                        formatCurrency(summary.pendingReceivable.amount);
                    document.getElementById('overdue-receivable-count').textContent = 
                        overdue.receivable.length;
                    document.getElementById('upcoming-receivable-count').textContent = 
                        upcoming.receivable.length;
                }
            } catch (error) {
                console.error('Erro ao carregar resumo de contas:', error);
            }
        }

        async function loadKPIs() {
            try {
                if (typeof kpiDashboard !== 'undefined') {
                    const kpis = kpiDashboard.kpis;
                    const kpiGrid = document.getElementById('kpi-grid');
                    
                    kpiGrid.innerHTML = '';
                    
                    kpis.forEach(kpi => {
                        const kpiItem = document.createElement('div');
                        kpiItem.className = 'kpi-item';
                        
                        const trendIcon = kpi.trend === 'increasing' ? 'fa-arrow-up trend-up' : 
                                        kpi.trend === 'decreasing' ? 'fa-arrow-down trend-down' : 
                                        'fa-minus trend-stable';
                        
                        kpiItem.innerHTML = `
                            <div class="kpi-value">${formatValue(kpi.currentValue, kpi.format)}</div>
                            <div class="kpi-label">${kpi.name}</div>
                            <div class="trend-indicator">
                                <i class="fas ${trendIcon}"></i>
                                ${kpi.changePercentage.toFixed(1)}%
                            </div>
                        `;
                        
                        kpiGrid.appendChild(kpiItem);
                    });
                }
            } catch (error) {
                console.error('Erro ao carregar KPIs:', error);
            }
        }

        async function loadAlerts() {
            try {
                const alertsContainer = document.getElementById('alerts-container');
                alertsContainer.innerHTML = '<p>Carregando alertas...</p>';
                
                // Simula carregamento de alertas
                setTimeout(() => {
                    alertsContainer.innerHTML = `
                        <div class="alert-item info">
                            <strong>Informação:</strong> Sistema funcionando normalmente
                        </div>
                        <div class="alert-item warning">
                            <strong>Atenção:</strong> 3 contas próximas do vencimento
                        </div>
                    `;
                }, 1000);
            } catch (error) {
                console.error('Erro ao carregar alertas:', error);
            }
        }

        async function loadDelinquencyAnalysis() {
            try {
                if (typeof accountsPayableReceivable !== 'undefined') {
                    const analysis = accountsPayableReceivable.getDelinquencyAnalysis();
                    const container = document.getElementById('delinquency-analysis');
                    
                    container.innerHTML = `
                        <div class="kpi-grid">
                            <div class="kpi-item">
                                <div class="kpi-value">${analysis.totalOverdue}</div>
                                <div class="kpi-label">Total de Contas Vencidas</div>
                            </div>
                            <div class="kpi-item">
                                <div class="kpi-value">${formatCurrency(analysis.totalOverdueAmount)}</div>
                                <div class="kpi-label">Valor Total Vencido</div>
                            </div>
                            <div class="kpi-item">
                                <div class="kpi-value">${analysis.agingAnalysis['90+'].count}</div>
                                <div class="kpi-label">Críticas (90+ dias)</div>
                            </div>
                        </div>
                        
                        <h4>Recomendações:</h4>
                        <div class="alerts-container">
                            ${analysis.recommendations.map(rec => `
                                <div class="alert-item ${rec.priority === 'high' ? 'critical' : 'warning'}">
                                    <strong>${rec.title}:</strong> ${rec.description}
                                    <br><small>${rec.action}</small>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Erro ao carregar análise de inadimplência:', error);
            }
        }

        async function loadProjections() {
            try {
                if (typeof financialProjections !== 'undefined') {
                    const projection = financialProjections.generateAdvancedProjection('12months', {
                        includeMonteCarlo: true,
                        sensitivityAnalysis: true
                    });
                    
                    // Cria gráfico de projeções
                    const ctx = document.getElementById('projections-chart').getContext('2d');
                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: projection.scenarios[1].data.map(p => p.period),
                            datasets: [
                                {
                                    label: 'Cenário Otimista',
                                    data: projection.scenarios[2].data.map(p => p.netCashFlow),
                                    borderColor: '#10b981',
                                    backgroundColor: 'rgba(16, 185, 129, 0.1)'
                                },
                                {
                                    label: 'Cenário Realista',
                                    data: projection.scenarios[1].data.map(p => p.netCashFlow),
                                    borderColor: '#3b82f6',
                                    backgroundColor: 'rgba(59, 130, 246, 0.1)'
                                },
                                {
                                    label: 'Cenário Pessimista',
                                    data: projection.scenarios[0].data.map(p => p.netCashFlow),
                                    borderColor: '#ef4444',
                                    backgroundColor: 'rgba(239, 68, 68, 0.1)'
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        callback: function(value) {
                                            return formatCurrency(value);
                                        }
                                    }
                                }
                            }
                        }
                    });
                    
                    // Resumo das projeções
                    const summary = projection.summary;
                    document.getElementById('projections-summary').innerHTML = `
                        <div class="kpi-grid">
                            <div class="kpi-item">
                                <div class="kpi-value">${formatCurrency(summary.mostLikely.netProfit)}</div>
                                <div class="kpi-label">Lucro Projetado (Realista)</div>
                            </div>
                            <div class="kpi-item">
                                <div class="kpi-value">${formatCurrency(summary.bestCase.netProfit)}</div>
                                <div class="kpi-label">Melhor Cenário</div>
                            </div>
                            <div class="kpi-item">
                                <div class="kpi-value">${formatCurrency(summary.worstCase.netProfit)}</div>
                                <div class="kpi-label">Pior Cenário</div>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Erro ao carregar projeções:', error);
            }
        }

        async function loadBudgetStatus() {
            try {
                if (typeof budgetControl !== 'undefined') {
                    const dashboardData = budgetControl.getDashboardData();
                    const container = document.getElementById('budget-status');
                    
                    container.innerHTML = `
                        <div class="kpi-grid">
                            <div class="kpi-item">
                                <div class="kpi-value">${formatCurrency(dashboardData.totalBudgeted)}</div>
                                <div class="kpi-label">Total Orçado</div>
                            </div>
                            <div class="kpi-item">
                                <div class="kpi-value">${formatCurrency(dashboardData.totalActual)}</div>
                                <div class="kpi-label">Total Gasto</div>
                            </div>
                            <div class="kpi-item">
                                <div class="kpi-value">${formatCurrency(dashboardData.totalVariance)}</div>
                                <div class="kpi-label">Variação</div>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Erro ao carregar status do orçamento:', error);
            }
        }

        async function loadInvestmentSummary() {
            try {
                if (typeof investmentManagement !== 'undefined') {
                    const summary = investmentManagement.getWealthSummary();
                    const container = document.getElementById('investment-summary');
                    
                    container.innerHTML = `
                        <div class="kpi-grid">
                            <div class="kpi-item">
                                <div class="kpi-value">${formatCurrency(summary.totalWealth)}</div>
                                <div class="kpi-label">Patrimônio Total</div>
                            </div>
                            <div class="kpi-item">
                                <div class="kpi-value">${formatCurrency(summary.totalInvestments)}</div>
                                <div class="kpi-label">Investimentos</div>
                            </div>
                            <div class="kpi-item">
                                <div class="kpi-value">${formatCurrency(summary.totalAssets)}</div>
                                <div class="kpi-label">Ativos</div>
                            </div>
                            <div class="kpi-item">
                                <div class="kpi-value">${summary.performance.totalReturnPercentage.toFixed(1)}%</div>
                                <div class="kpi-label">Retorno Total</div>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Erro ao carregar resumo de investimentos:', error);
            }
        }

        async function loadReports() {
            try {
                if (typeof financialReports !== 'undefined') {
                    const reports = financialReports.reports;
                    const tbody = document.getElementById('reports-tbody');
                    
                    tbody.innerHTML = reports.map(report => `
                        <tr>
                            <td>${report.name}</td>
                            <td>${report.period ? `${report.period.startDate} a ${report.period.endDate}` : report.date}</td>
                            <td><span class="status-badge status-paid">Concluído</span></td>
                            <td>${new Date(report.generatedAt).toLocaleDateString('pt-BR')}</td>
                            <td>
                                <button class="btn btn-sm" onclick="viewReport('${report.id}')">
                                    <i class="fas fa-eye"></i> Ver
                                </button>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('Erro ao carregar relatórios:', error);
            }
        }

        async function loadAuditLogs() {
            try {
                if (typeof auditSystem !== 'undefined') {
                    const searchResult = auditSystem.searchLogs({ limit: 10 });
                    const tbody = document.getElementById('audit-tbody');
                    
                    tbody.innerHTML = searchResult.logs.map(log => `
                        <tr>
                            <td>${new Date(log.timestamp).toLocaleString('pt-BR')}</td>
                            <td>${log.username}</td>
                            <td>${log.action}</td>
                            <td>${log.entity}</td>
                            <td>
                                <span class="status-badge status-${log.severity}">
                                    ${log.severity.toUpperCase()}
                                </span>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('Erro ao carregar logs de auditoria:', error);
            }
        }

        function updateDashboard() {
            console.log('Atualizando dashboard...');
            loadFinancialSummary();
            loadAccountsSummary();
            loadKPIs();
            loadAlerts();
        }

        function formatCurrency(value) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(value);
        }

        function formatValue(value, format) {
            switch (format) {
                case 'currency':
                    return formatCurrency(value);
                case 'percentage':
                    return `${value.toFixed(1)}%`;
                case 'number':
                    return value.toLocaleString('pt-BR');
                default:
                    return value.toString();
            }
        }

        function viewReport(reportId) {
            alert(`Visualizando relatório ${reportId}`);
        }
    </script>
</body>
</html>
